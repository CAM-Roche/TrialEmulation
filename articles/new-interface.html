<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Interface â€¢ TrialEmulation</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="New Interface">
<meta property="og:description" content="TrialEmulation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">TrialEmulation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.3.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Getting-Started.html">Getting-Started</a>
    </li>
    <li>
      <a href="../articles/new-interface.html">New Interface</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Causal-LDA/TrialEmulation/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>New Interface</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Causal-LDA/TrialEmulation/blob/HEAD/vignettes/new-interface.Rmd" class="external-link"><code>vignettes/new-interface.Rmd</code></a></small>
      <div class="hidden name"><code>new-interface.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://causal-lda.github.io/TrialEmulation/">TrialEmulation</a></span><span class="op">)</span></span></code></pre></div>
<p>To improve usability, we have implemented a new user interface. This
allows a more structured specification of the target trial emulation
process.</p>
<p>It also gives flexibility to add new methods and tools for parts of
the analysis. For example, we now allow different ways of storing the
expanded data: as CSV files and in a DuckDB database. We also allow
different weight fitting model procedures: using <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a></code>
or <code><a href="https://rdrr.io/pkg/parglm/man/parglm.html" class="external-link">parglm::parglm</a></code>. New components can quickly and easily be
specified for use with this package.</p>
<div class="section level2">
<h2 id="user-interface">User Interface<a class="anchor" aria-label="anchor" href="#user-interface"></a>
</h2>
<p>A sequence of target trials analysis starts by specifying which
estimand will be used:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_sequence.html">trial_sequence</a></span><span class="op">(</span>estimand <span class="op">=</span> <span class="st">"PP"</span><span class="op">)</span> <span class="co"># Per-protocol</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_sequence.html">trial_sequence</a></span><span class="op">(</span>estimand <span class="op">=</span> <span class="st">"ITT"</span><span class="op">)</span> <span class="co"># Intention-to-treat</span></span></code></pre></div>
<p>Additionally it is useful to create a directory to save files for
later inspection.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"trial_pp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">trial_pp_dir</span><span class="op">)</span></span>
<span><span class="va">trial_itt_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"trial_itt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">trial_itt_dir</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>Next the user must specify the data that will be used. Here we need
to specify which columns contain which values and how they should be
used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data_censored"</span><span class="op">)</span></span>
<span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_censored</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>    eligible <span class="op">=</span> <span class="st">"eligible"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Function style without pipes</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_censored</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>  eligible <span class="op">=</span> <span class="st">"eligible"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can inspect our object by printing:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Intention-to-treat </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 725 observations from 89 patients </span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 724:    99      6         1     1 -0.033762356     1 0.5752681    71 3.00000000</span></span>
<span><span class="co">#&gt; 725:    99      7         0     0 -1.340496520     1 0.5752681    72 3.08333333</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 724:       0        0        0             7  FALSE     1     4      0</span></span>
<span><span class="co">#&gt; 725:       1        0        0             7  FALSE     1     4      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 724:            5              1         0         1</span></span>
<span><span class="co">#&gt; 725:            7              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - No weight model specified</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="weight-models">Weight Models<a class="anchor" aria-label="anchor" href="#weight-models"></a>
</h3>
<p>To adjust for the effects of informative censoring, inverse
probability of censoring weights (IPCW) can be applied. To estimate
these weights, we construct survival models. Two sets of models are fit
for the two censoring mechanisms which may apply: censoring due to
deviation from assigned treatment, and other informative censoring.</p>
<div class="section level4">
<h4 id="censoring-due-to-treatment-switching">Censoring due to treatment switching<a class="anchor" aria-label="anchor" href="#censoring-due-to-treatment-switching"></a>
</h4>
<p>We specify model formulas to be used for calculating the probability
of receiving treatment in the current period. Separate models are fitted
for patients who had <code>treatment = 1</code> and those who had
<code>treatment = 0</code> in the previous period. Stabilized weights
are used by fitting numerator and denominator models.</p>
<p>There are optional arguments to specify columns which can
include/exclude observations from the treatment models. These are used
in case it is not possible for a patient to deviate from a certain
treatment assignment in that period.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_switch_weight_model.html">set_switch_weight_model</a></span><span class="op">(</span></span>
<span>    numerator <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>    denominator <span class="op">=</span> <span class="op">~</span><span class="va">age</span>,</span>
<span>    model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - No weight model specified </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ treatment age + x1 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ treatment age </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted</span></span></code></pre></div>
<p>This type of censoring is not used with an ITT estimand, so we cannot
use <code><a href="../reference/set_switch_weight_model.html">set_switch_weight_model()</a></code> with <code>trial_ITT</code>
objects.</p>
</div>
<div class="section level4">
<h4 id="other-informative-censoring">Other informative censoring<a class="anchor" aria-label="anchor" href="#other-informative-censoring"></a>
</h4>
<p>In case there is other informative censoring occurring in the data,
we can create similar models to estimate the IPCW. These can be used
with all types of estimand. Compared to
<code>set_switch_weight_model</code> there are additional required
arguments:</p>
<ul>
<li>
<code>censor_event</code> which specifies the column containing the
censoring indicator</li>
<li>
<code>pool_models</code> which species that models may be fit
separately (as in <code>set_switch_weight_model</code>) or pooled across
the treatments in the previous period. The choices are
<code>"none"</code>, <code>"both"</code>, or <code>"numerator"</code>
only. The default and allowed choices depends on the estimand.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_censor_weight_model.html">set_censor_weight_model</a></span><span class="op">(</span></span>
<span>    censor_event <span class="op">=</span> <span class="st">"censored"</span>,</span>
<span>    numerator <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>    denominator <span class="op">=</span> <span class="op">~</span><span class="va">x2</span>,</span>
<span>    pool_models <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ 1 - censored x1 + x2 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ 1 - censored x2 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ treatment age + x1 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ treatment age </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_censor_weight_model.html">set_censor_weight_model</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  censor_event <span class="op">=</span> <span class="st">"censored"</span>,</span>
<span>  numerator <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>  denominator <span class="op">=</span> <span class="op">~</span><span class="va">x2</span>,</span>
<span>  pool_models <span class="op">=</span> <span class="st">"numerator"</span>,</span>
<span>  model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">trial_itt</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Intention-to-treat </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 725 observations from 89 patients </span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 724:    99      6         1     1 -0.033762356     1 0.5752681    71 3.00000000</span></span>
<span><span class="co">#&gt; 725:    99      7         0     0 -1.340496520     1 0.5752681    72 3.08333333</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 724:       0        0        0             7  FALSE     1     4      0</span></span>
<span><span class="co">#&gt; 725:       1        0        0             7  FALSE     1     4      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 724:            5              1         0         1</span></span>
<span><span class="co">#&gt; 725:            7              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ 1 - censored x1 + x2 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ 1 - censored x2 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="calculate-weights">Calculate Weights<a class="anchor" aria-label="anchor" href="#calculate-weights"></a>
</h4>
<p>Next we need to fit the individual models and combine them into
weights. This is done with <code><a href="../reference/calculate_weights.html">calculate_weights()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/calculate_weights.html">calculate_weights</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt; Indices: &lt;am_1&gt;, &lt;treatment&gt;</span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1       wt       p_n</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;    &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0 1.470991 0.5908820</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1 1.107245 0.7735665</span></span>
<span><span class="co">#&gt;  ---                                                                   </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1 1.010639 0.5602335</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1 1.022719 0.5545296</span></span>
<span><span class="co">#&gt;            p_d       wtS      pC_n      pC_d      wtC</span></span>
<span><span class="co">#&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1: 0.4706283 1.2555173 0.8032410 0.6855809 1.171621</span></span>
<span><span class="co">#&gt;   2: 0.7174218 1.0782589 0.9643771 0.9391313 1.026882</span></span>
<span><span class="co">#&gt;  ---                                                 </span></span>
<span><span class="co">#&gt; 320: 0.5621482 0.9965939 0.9599814 0.9466406 1.014093</span></span>
<span><span class="co">#&gt; 321: 0.5563530 1.0041101 0.9432893 0.9261254 1.018533</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ 1 - censored x1 + x2 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ 1 - censored x2 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; View weight model summaries with show_weight_models() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: ~ treatment age + x1 + x3 </span></span>
<span><span class="co">#&gt;  - Denominator formula: ~ treatment age </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; View weight model summaries with show_weight_models()</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_weights.html">calculate_weights</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span></code></pre></div>
<p>The full model objects are saved to disk in the directories we
created above. The summaries are stored in the trial sequence object and
can be printed:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/show_weight_models.html">show_weight_models</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X) for numerator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate   std.error statistic  p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  2.2969825 0.2206891 10.4082295 2.274117e-25</span></span>
<span><span class="co">#&gt;  x1           0.6982406 0.3074148  2.2713304 2.312698e-02</span></span>
<span><span class="co">#&gt;  x2          -0.4763835 0.1378165 -3.4566513 5.469321e-04</span></span>
<span><span class="co">#&gt;  x3          -0.1794884 0.2782355 -0.6450952 5.188655e-01</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  404.2156      724     -193.6748 395.3495 413.6942 387.3495 721         725 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                         </span></span>
<span><span class="co">#&gt;  /tmp/RtmpeR2F81/trial_pp/switch_models/model_19cd5e9846a5.rds</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X, previous treatment = 0) for denominator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate  std.error statistic p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  2.245008 0.1717699 13.069858 4.895660e-39</span></span>
<span><span class="co">#&gt;  x2          -0.573941 0.1670093 -3.436581 5.891065e-04</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  283.0723      425     -135.4361 274.8722 282.9811 270.8722 424         426 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                         </span></span>
<span><span class="co">#&gt;  /tmp/RtmpeR2F81/trial_pp/switch_models/model_19cd291bc97a.rds</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X, previous treatment = 1) for denominator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate     std.error statistic   p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  3.011579099 0.2873146 10.48181591 1.047135e-25</span></span>
<span><span class="co">#&gt;  x2          -0.005692433 0.2704827 -0.02104546 9.832094e-01</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  113.0528      298     -56.52619 117.0524 124.4533 113.0524 297         299 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                         </span></span>
<span><span class="co">#&gt;  /tmp/RtmpeR2F81/trial_pp/switch_models/model_19cd79da10a7.rds</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="specify-outcome-model">Specify Outcome Model<a class="anchor" aria-label="anchor" href="#specify-outcome-model"></a>
</h3>
<p>Not fully implemented. Needs to be preliminarily set at this stage to
make sure all required variables are included in the expanded data
set</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu">set_outcome_model</span><span class="op">(</span><span class="va">trial_pp</span><span class="op">)</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu">set_outcome_model</span><span class="op">(</span><span class="va">trial_itt</span>, adjustment_terms <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="expand-trials">Expand Trials<a class="anchor" aria-label="anchor" href="#expand-trials"></a>
</h3>
<p>Now we are ready to create the data set with all of the sequence of
target trials. First we specify some options for the expansion and then
expand.</p>
<div class="section level4">
<h4 id="set-expansion-options">Set Expansion Options<a class="anchor" aria-label="anchor" href="#set-expansion-options"></a>
</h4>
<p>There are two options to set</p>
<ul>
<li>output: specifies how and where the expanded data will be saved. As
it can be very large, we may need to save it to disk with CSV files or
DuckDB, using a <code>save_to_*</code> function.</li>
<li>chunk_size: if the expanded data is too large to fit in memory, we
need to process it in chunks by specifying how many patients are
processed at one time.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>    output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_csv.html">save_to_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"trial_csvs"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_csv.html">save_to_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_itt_dir</span>, <span class="st">"trial_csvs"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_datatable.html">save_to_datatable</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-sequence-of-trials-data">Create Sequence of Trials Data<a class="anchor" aria-label="anchor" href="#create-sequence-of-trials-data"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_trials.html">expand_trials</a></span><span class="op">(</span><span class="va">trial_pp</span><span class="op">)</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_trials.html">expand_trials</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span></code></pre></div>
<p>Show method not implemented yet</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span><span class="op">@</span><span class="va">expansion</span></span>
<span><span class="co">#&gt; An object of class "te_expansion"</span></span>
<span><span class="co">#&gt; Slot "chunk_size":</span></span>
<span><span class="co">#&gt; [1] 500</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "datastore":</span></span>
<span><span class="co">#&gt; An object of class "te_datastore_csv"</span></span>
<span><span class="co">#&gt; Slot "path":</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpeR2F81/trial_pp/trial_csvs"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "files":</span></span>
<span><span class="co">#&gt;  [1] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_0.csv" </span></span>
<span><span class="co">#&gt;  [2] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_1.csv" </span></span>
<span><span class="co">#&gt;  [3] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_2.csv" </span></span>
<span><span class="co">#&gt;  [4] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_3.csv" </span></span>
<span><span class="co">#&gt;  [5] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_4.csv" </span></span>
<span><span class="co">#&gt;  [6] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_5.csv" </span></span>
<span><span class="co">#&gt;  [7] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_6.csv" </span></span>
<span><span class="co">#&gt;  [8] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_7.csv" </span></span>
<span><span class="co">#&gt;  [9] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_8.csv" </span></span>
<span><span class="co">#&gt; [10] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_9.csv" </span></span>
<span><span class="co">#&gt; [11] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_10.csv"</span></span>
<span><span class="co">#&gt; [12] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_11.csv"</span></span>
<span><span class="co">#&gt; [13] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_12.csv"</span></span>
<span><span class="co">#&gt; [14] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_13.csv"</span></span>
<span><span class="co">#&gt; [15] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_14.csv"</span></span>
<span><span class="co">#&gt; [16] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_15.csv"</span></span>
<span><span class="co">#&gt; [17] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_16.csv"</span></span>
<span><span class="co">#&gt; [18] "/tmp/RtmpeR2F81/trial_pp/trial_csvs/trial_17.csv"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "template":</span></span>
<span><span class="co">#&gt; Empty data.table (0 rows and 6 cols): id,trial_period,followup_time,outcome,weight,treatment</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "N":</span></span>
<span><span class="co">#&gt; [1] 500</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "censor_at_switch":</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "first_period":</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "last_period":</span></span>
<span><span class="co">#&gt; [1] Inf</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span><span class="op">@</span><span class="va">expansion</span></span>
<span><span class="co">#&gt; An object of class "te_expansion"</span></span>
<span><span class="co">#&gt; Slot "chunk_size":</span></span>
<span><span class="co">#&gt; [1] 500</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "datastore":</span></span>
<span><span class="co">#&gt; An object of class "te_datastore_datatable"</span></span>
<span><span class="co">#&gt; Slot "data":</span></span>
<span><span class="co">#&gt;          id trial_period followup_time outcome    weight treatment</span></span>
<span><span class="co">#&gt;       &lt;int&gt;        &lt;int&gt;         &lt;int&gt;   &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:     1            0             0       0 1.0000000         1</span></span>
<span><span class="co">#&gt;    2:     1            0             1       0 0.9991778         1</span></span>
<span><span class="co">#&gt;    3:     1            0             2       0 0.9706253         1</span></span>
<span><span class="co">#&gt;    4:     1            0             3       0 0.9250241         1</span></span>
<span><span class="co">#&gt;    5:     1            0             4       0 0.9196129         1</span></span>
<span><span class="co">#&gt;   ---                                                             </span></span>
<span><span class="co">#&gt; 1554:    99            0             3       0 0.8017062         0</span></span>
<span><span class="co">#&gt; 1555:    99            0             4       0 0.7903901         0</span></span>
<span><span class="co">#&gt; 1556:    99            0             5       0 0.8348576         1</span></span>
<span><span class="co">#&gt; 1557:    99            0             6       0 0.8272091         1</span></span>
<span><span class="co">#&gt; 1558:    99            0             7       1 0.8157754         0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "N":</span></span>
<span><span class="co">#&gt; [1] 1558</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "censor_at_switch":</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "first_period":</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Slot "last_period":</span></span>
<span><span class="co">#&gt; [1] Inf</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="sample-from-expanded-data">Sample from Expanded Data<a class="anchor" aria-label="anchor" href="#sample-from-expanded-data"></a>
</h3>
<p>Sample method not implemented yet</p>
</div>
<div class="section level3">
<h3 id="fit-marginal-structural-model">Fit Marginal Structural Model<a class="anchor" aria-label="anchor" href="#fit-marginal-structural-model"></a>
</h3>
<p>Outcome model fitting not implemented yet</p>
</div>
<div class="section level3">
<h3 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h3>
<p>Model summaries not implemented</p>
</div>
</div>
<div class="section level2">
<h2 id="class-structure">Class Structure<a class="anchor" aria-label="anchor" href="#class-structure"></a>
</h2>
<p>The main class in this new interface is <code>trial_sequence</code>
which is the parent class of the estimand specific classes
<code>trial_sequence_ITT</code>, <code>trial_sequence_PP</code> and
<code>trial_sequence_AT</code>. These child classes allow for
restrictions and differences in processing based on the different
estimands. Where necessary we have S4 methods defined for the estimand
specific classes and otherwise common processing is defined in methods
for the <code>trial_sequence</code> class.</p>
<p>The <code>trial_sequence</code> class contains slots needed to define
the sequence of target trials analysis</p>
<ul>
<li>estimand = <code>character</code>
</li>
<li>data = <code>te_data</code>
</li>
<li>censor_weights = <code>te_weights_spec</code>
</li>
<li>expansion = <code>te_expansion</code>
</li>
<li>outcome_model = <code>te_outcome_model</code>
</li>
</ul>
<div class="section level3">
<h3 id="te_data">
<code>te_data</code><a class="anchor" aria-label="anchor" href="#te_data"></a>
</h3>
<p>Contains the input data. It under goes some manipulation in
<code><a href="../reference/set_data.html">set_data()</a></code> to standardise the column names.</p>
</div>
<div class="section level3">
<h3 id="te_weights_spec">
<code>te_weights_spec</code><a class="anchor" aria-label="anchor" href="#te_weights_spec"></a>
</h3>
<p>Contains specification for the IPCW models, including formulas, model
fitter, pooling option, and (once fitted) the model summaries.</p>
<div class="section level4">
<h4 id="te_weights_fitter">te_weights_fitter<a class="anchor" aria-label="anchor" href="#te_weights_fitter"></a>
</h4>
<p>The model fitter is specified as an object of class
<code>te_weights_fitter</code>. This class is used to save parameters
which are used in the method
<code>fit_weights_model(object, data, formula, label)</code> where
object is the <code>te_weights_fitter</code>. It fits a model and
returns a <code>te_weights_fitted</code> object containing the label,
model summaries and the fitted values from the model.</p>
</div>
<div class="section level4">
<h4 id="te_weights_fitted">te_weights_fitted<a class="anchor" aria-label="anchor" href="#te_weights_fitted"></a>
</h4>
<p>The <code>te_weights_fitted</code> objects are saved in a list in
<code>te_weights_spec</code> in a slot <code>fitted</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="te_outcome_model">
<code>te_outcome_model</code><a class="anchor" aria-label="anchor" href="#te_outcome_model"></a>
</h3>
<p>To be finalised.</p>
</div>
<div class="section level3">
<h3 id="te_expansion">
<code>te_expansion</code><a class="anchor" aria-label="anchor" href="#te_expansion"></a>
</h3>
<p>The <code>te_expansion</code> class defines how the sequence of
trials should be expanded. It contains slots for chunk_size, how
censoring is applied, first and last periods, and an object of class
<code>te_datastore</code> which defines how the data is saved.</p>
<div class="section level4">
<h4 id="te_datastore">
<code>te_datastore</code><a class="anchor" aria-label="anchor" href="#te_datastore"></a>
</h4>
<p>This class contains slots needed for saving the expanded data, such
as file path. Child classes are defined for each storage type, such as
<code>te_datastore_csv</code>, <code>te_datastore_duckdb</code>. Each of
these classes has a user-friendly <code>save_to_*()</code> method to
setup the storage.</p>
<p>To define a new storage type, a method
<code>save_expanded_data(object, data)</code> needs to be defined. This
takes the data store object and a <code>data.frame</code> to be saved.
This method may be called repeatedly if only a chunk of patients are
being processed and so should appropriately append the data. The method
returns an updated <code>te_datastore_*</code> object which is saved in
the <code>trial_sequence@te_expansion</code> slot.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Roonak Rezvani, Isaac Gravestock, Li Su, Medical Research Council (MRC), F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
