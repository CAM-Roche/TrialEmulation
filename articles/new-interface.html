<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>New Interface â€¢ TrialEmulation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="New Interface">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TrialEmulation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3.33</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Getting-Started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/new-interface.html">New Interface</a></li>
    <li><a class="dropdown-item" href="../articles/Extending-TrialEmulation.html">Extending TrialEmulation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Causal-LDA/TrialEmulation/" aria-label="github"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>New Interface</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Causal-LDA/TrialEmulation/blob/main/vignettes/new-interface.Rmd" class="external-link"><code>vignettes/new-interface.Rmd</code></a></small>
      <div class="d-none name"><code>new-interface.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://causal-lda.github.io/TrialEmulation/">TrialEmulation</a></span><span class="op">)</span></span></code></pre></div>
<p>To improve usability, we have implemented a new user interface. This
allows a more structured specification of the target trial emulation
process.</p>
<p>It also gives flexibility to add new methods and tools for parts of
the analysis. For example, we now allow different ways of storing the
expanded data: as CSV files and in a DuckDB database. We also allow
different weight fitting model procedures: using <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a></code>
or <code><a href="https://rdrr.io/pkg/parglm/man/parglm.html" class="external-link">parglm::parglm</a></code>. New components can quickly and easily be
specified for use with this package.</p>
<div class="section level2">
<h2 id="user-interface">User Interface<a class="anchor" aria-label="anchor" href="#user-interface"></a>
</h2>
<p>A sequence of target trials analysis starts by specifying which
estimand will be used:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_sequence.html">trial_sequence</a></span><span class="op">(</span>estimand <span class="op">=</span> <span class="st">"PP"</span><span class="op">)</span> <span class="co"># Per-protocol</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial_sequence.html">trial_sequence</a></span><span class="op">(</span>estimand <span class="op">=</span> <span class="st">"ITT"</span><span class="op">)</span> <span class="co"># Intention-to-treat</span></span></code></pre></div>
<p>Additionally it is useful to create a directory to save files for
later inspection.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"trial_pp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">trial_pp_dir</span><span class="op">)</span></span>
<span><span class="va">trial_itt_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"trial_itt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">trial_itt_dir</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>Next the user must specify the data that will be used. Here we need
to specify which columns contain which values and how they should be
used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data_censored"</span><span class="op">)</span></span>
<span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_censored</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>    eligible <span class="op">=</span> <span class="st">"eligible"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Function style without pipes</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_censored</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>  eligible <span class="op">=</span> <span class="st">"eligible"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can inspect our object by printing:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Intention-to-treat </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 725 observations from 89 patients </span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 724:    99      6         1     1 -0.033762356     1 0.5752681    71 3.00000000</span></span>
<span><span class="co">#&gt; 725:    99      7         0     0 -1.340496520     1 0.5752681    72 3.08333333</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 724:       0        0        0             7  FALSE     1     4      0</span></span>
<span><span class="co">#&gt; 725:       1        0        0             7  FALSE     1     4      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 724:            5              1         0         1</span></span>
<span><span class="co">#&gt; 725:            7              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - No weight model specified </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; No expanded data, use expand_trials() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Outcome model: </span></span>
<span><span class="co">#&gt;  - Outcome model not specified. Use set_outcome_model() </span></span>
<span><span class="co">#&gt; No outcome data, use load_expanded_data()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="weight-models">Weight Models<a class="anchor" aria-label="anchor" href="#weight-models"></a>
</h3>
<p>To adjust for the effects of informative censoring, inverse
probability of censoring weights (IPCW) can be applied. To estimate
these weights, we construct survival models. Two sets of models are fit
for the two censoring mechanisms which may apply: censoring due to
deviation from assigned treatment, and other informative censoring.</p>
<div class="section level4">
<h4 id="censoring-due-to-treatment-switching">Censoring due to treatment switching<a class="anchor" aria-label="anchor" href="#censoring-due-to-treatment-switching"></a>
</h4>
<p>We specify model formulas to be used for calculating the probability
of receiving treatment in the current period. Separate models are fitted
for patients who had <code>treatment = 1</code> and those who had
<code>treatment = 0</code> in the previous period. Stabilized weights
are used by fitting numerator and denominator models.</p>
<p>There are optional arguments to specify columns which can
include/exclude observations from the treatment models. These are used
in case it is not possible for a patient to deviate from a certain
treatment assignment in that period.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_switch_weight_model.html">set_switch_weight_model</a></span><span class="op">(</span></span>
<span>    numerator <span class="op">=</span> <span class="op">~</span><span class="va">age</span>,</span>
<span>    denominator <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>    model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - No weight model specified </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: treatment ~ age </span></span>
<span><span class="co">#&gt;  - Denominator formula: treatment ~ age + x1 + x3 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; No expanded data, use expand_trials() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Outcome model: </span></span>
<span><span class="co">#&gt;  - Outcome model not specified. Use set_outcome_model() </span></span>
<span><span class="co">#&gt; No outcome data, use load_expanded_data()</span></span></code></pre></div>
<p>This type of censoring is not used with an ITT estimand, so we cannot
use <code><a href="../reference/set_switch_weight_model.html">set_switch_weight_model()</a></code> with <code>trial_ITT</code>
objects.</p>
</div>
<div class="section level4">
<h4 id="other-informative-censoring">Other informative censoring<a class="anchor" aria-label="anchor" href="#other-informative-censoring"></a>
</h4>
<p>In case there is other informative censoring occurring in the data,
we can create similar models to estimate the IPCW. These can be used
with all types of estimand. Compared to
<code>set_switch_weight_model</code> there are additional required
arguments:</p>
<ul>
<li>
<code>censor_event</code> which specifies the column containing the
censoring indicator</li>
<li>
<code>pool_models</code> which species that models may be fit
separately (as in <code>set_switch_weight_model</code>) or pooled across
the treatments in the previous period. The choices are
<code>"none"</code>, <code>"both"</code>, or <code>"numerator"</code>
only. The default and allowed choices depends on the estimand.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_censor_weight_model.html">set_censor_weight_model</a></span><span class="op">(</span></span>
<span>    censor_event <span class="op">=</span> <span class="st">"censored"</span>,</span>
<span>    numerator <span class="op">=</span> <span class="op">~</span><span class="va">x2</span>,</span>
<span>    denominator <span class="op">=</span> <span class="op">~</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x1</span>,</span>
<span>    pool_models <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: 1 - censored ~ x2 </span></span>
<span><span class="co">#&gt;  - Denominator formula: 1 - censored ~ x2 + x1 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: treatment ~ age </span></span>
<span><span class="co">#&gt;  - Denominator formula: treatment ~ age + x1 + x3 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; No expanded data, use expand_trials() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Outcome model: </span></span>
<span><span class="co">#&gt;  - Outcome model not specified. Use set_outcome_model() </span></span>
<span><span class="co">#&gt; No outcome data, use load_expanded_data()</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_censor_weight_model.html">set_censor_weight_model</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  censor_event <span class="op">=</span> <span class="st">"censored"</span>,</span>
<span>  numerator <span class="op">=</span> <span class="op">~</span><span class="va">x2</span>,</span>
<span>  denominator <span class="op">=</span> <span class="op">~</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x1</span>,</span>
<span>  pool_models <span class="op">=</span> <span class="st">"numerator"</span>,</span>
<span>  model_fitter <span class="op">=</span> <span class="fu"><a href="../reference/stats_glm_logit.html">stats_glm_logit</a></span><span class="op">(</span>save_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_itt_dir</span>, <span class="st">"switch_models"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">trial_itt</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Intention-to-treat </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 725 observations from 89 patients </span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 724:    99      6         1     1 -0.033762356     1 0.5752681    71 3.00000000</span></span>
<span><span class="co">#&gt; 725:    99      7         0     0 -1.340496520     1 0.5752681    72 3.08333333</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 724:       0        0        0             7  FALSE     1     4      0</span></span>
<span><span class="co">#&gt; 725:       1        0        0             7  FALSE     1     4      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 724:            5              1         0         1</span></span>
<span><span class="co">#&gt; 725:            7              2         0         1</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: 1 - censored ~ x2 </span></span>
<span><span class="co">#&gt;  - Denominator formula: 1 - censored ~ x2 + x1 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; Weight models not fitted </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; No expanded data, use expand_trials() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Outcome model: </span></span>
<span><span class="co">#&gt;  - Outcome model not specified. Use set_outcome_model() </span></span>
<span><span class="co">#&gt; No outcome data, use load_expanded_data()</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="calculate-weights">Calculate Weights<a class="anchor" aria-label="anchor" href="#calculate-weights"></a>
</h4>
<p>Next we need to fit the individual models and combine them into
weights. This is done with <code><a href="../reference/calculate_weights.html">calculate_weights()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/calculate_weights.html">calculate_weights</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">trial_pp</span></span>
<span><span class="co">#&gt; Trial Sequence Object </span></span>
<span><span class="co">#&gt; Estimand: Per-protocol </span></span>
<span><span class="co">#&gt; Data </span></span>
<span><span class="co">#&gt; N: 321 observations from 89 patients </span></span>
<span><span class="co">#&gt;         id period treatment    x1           x2    x3        x4   age      age_s</span></span>
<span><span class="co">#&gt;      &lt;int&gt;  &lt;int&gt;     &lt;num&gt; &lt;num&gt;        &lt;num&gt; &lt;int&gt;     &lt;num&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1      0         1     1  1.146148362     0 0.7342030    36 0.08333333</span></span>
<span><span class="co">#&gt;   2:     1      1         1     1  0.002200337     0 0.7342030    37 0.16666667</span></span>
<span><span class="co">#&gt;  ---                                                                           </span></span>
<span><span class="co">#&gt; 320:    99      1         1     0 -1.106480738     1 0.5752681    66 2.58333333</span></span>
<span><span class="co">#&gt; 321:    99      2         0     0  1.650478074     1 0.5752681    67 2.66666667</span></span>
<span><span class="co">#&gt;      outcome censored eligible time_of_event  first  am_1  cumA switch</span></span>
<span><span class="co">#&gt;        &lt;num&gt;    &lt;int&gt;    &lt;num&gt;         &lt;num&gt; &lt;lgcl&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:       0        0        1          9999   TRUE     0     1      0</span></span>
<span><span class="co">#&gt;   2:       0        0        0          9999  FALSE     1     2      0</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 320:       0        0        0             7  FALSE     1     2      0</span></span>
<span><span class="co">#&gt; 321:       0        0        0             7  FALSE     1     2      1</span></span>
<span><span class="co">#&gt;      regime_start time_on_regime eligible0 eligible1        wt       p_n</span></span>
<span><span class="co">#&gt;             &lt;int&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:            0              0         1         0 0.6994385 0.4706283</span></span>
<span><span class="co">#&gt;   2:            0              1         0         1 0.8951447 0.7174218</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 320:            0              1         0         1 1.0122336 0.5621482</span></span>
<span><span class="co">#&gt; 321:            2              2         0         1 1.0157064 0.5563530</span></span>
<span><span class="co">#&gt;            p_d       wtS      pC_n      pC_d       wtC</span></span>
<span><span class="co">#&gt;          &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1: 0.5908820 0.7964844 0.6855809 0.7807041 0.8781572</span></span>
<span><span class="co">#&gt;   2: 0.7735665 0.9274210 0.9391313 0.9729936 0.9651978</span></span>
<span><span class="co">#&gt;  ---                                                  </span></span>
<span><span class="co">#&gt; 320: 0.5602335 1.0034178 0.9466406 0.9383961 1.0087858</span></span>
<span><span class="co">#&gt; 321: 0.5545296 0.9959067 0.9261254 0.9080719 1.0198811</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for informative censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: 1 - censored ~ x2 </span></span>
<span><span class="co">#&gt;  - Denominator formula: 1 - censored ~ x2 + x1 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; View weight model summaries with show_weight_models() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; IPW for treatment switch censoring: </span></span>
<span><span class="co">#&gt;  - Numerator formula: treatment ~ age </span></span>
<span><span class="co">#&gt;  - Denominator formula: treatment ~ age + x1 + x3 </span></span>
<span><span class="co">#&gt; Model fitter type: te_stats_glm_logit </span></span>
<span><span class="co">#&gt; View weight model summaries with show_weight_models() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; No expanded data, use expand_trials() </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Outcome model: </span></span>
<span><span class="co">#&gt;  - Outcome model not specified. Use set_outcome_model() </span></span>
<span><span class="co">#&gt; No outcome data, use load_expanded_data()</span></span>
<span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_weights.html">calculate_weights</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span></code></pre></div>
<p>The full model objects are saved to disk in the directories we
created above. The summaries are stored in the trial sequence object and
can be printed:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/show_weight_models.html">show_weight_models</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X) for numerator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate   std.error statistic p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  2.4480907 0.1405726 17.415128 6.334656e-68</span></span>
<span><span class="co">#&gt;  x2          -0.4486482 0.1368765 -3.277759 1.046346e-03</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  404.2156      724     -196.7002 397.4004 406.5727 393.4004 723         725 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                          </span></span>
<span><span class="co">#&gt;  /tmp/RtmpIu5Hd0/trial_itt/switch_models/model_1b6022df7376.rds</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X, previous treatment = 0) for denominator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate   std.error statistic p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  1.8941961 0.2071122  9.145746 5.921948e-20</span></span>
<span><span class="co">#&gt;  x2          -0.5898292 0.1693402 -3.483101 4.956409e-04</span></span>
<span><span class="co">#&gt;  x1           0.8552603 0.3452930  2.476912 1.325247e-02</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  283.0723      425     -132.1655 270.3309 282.4943 264.3309 423         426 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                        </span></span>
<span><span class="co">#&gt;  /tmp/RtmpIu5Hd0/trial_itt/switch_models/model_1b601f1eb7.rds</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Model: P(censor_event = 0 | X, previous treatment = 1) for denominator </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  term        estimate    std.error statistic  p.value     </span></span>
<span><span class="co">#&gt;  (Intercept)  2.81443372 0.3122688  9.0128570 2.007570e-19</span></span>
<span><span class="co">#&gt;  x2          -0.03713196 0.2699579 -0.1375472 8.905983e-01</span></span>
<span><span class="co">#&gt;  x1           0.89351418 0.7771954  1.1496648 2.502819e-01</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  null.deviance df.null logLik    AIC      BIC      deviance df.residual nobs</span></span>
<span><span class="co">#&gt;  113.0528      298     -55.72938 117.4588 128.5601 111.4588 296         299 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  path                                                          </span></span>
<span><span class="co">#&gt;  /tmp/RtmpIu5Hd0/trial_itt/switch_models/model_1b605c6bf4ae.rds</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="specify-outcome-model">Specify Outcome Model<a class="anchor" aria-label="anchor" href="#specify-outcome-model"></a>
</h3>
<p>Not fully implemented. Needs to be preliminarily set at this stage to
make sure all required variables are included in the expanded data
set</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_outcome_model.html">set_outcome_model</a></span><span class="op">(</span><span class="va">trial_pp</span><span class="op">)</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_outcome_model.html">set_outcome_model</a></span><span class="op">(</span><span class="va">trial_itt</span>, adjustment_terms <span class="op">=</span> <span class="op">~</span><span class="va">x2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="expand-trials">Expand Trials<a class="anchor" aria-label="anchor" href="#expand-trials"></a>
</h3>
<p>Now we are ready to create the data set with all of the sequence of
target trials. First we specify some options for the expansion and then
expand.</p>
<div class="section level4">
<h4 id="set-expansion-options">Set Expansion Options<a class="anchor" aria-label="anchor" href="#set-expansion-options"></a>
</h4>
<p>There are two options to set</p>
<ul>
<li>output: specifies how and where the expanded data will be saved. As
it can be very large, we may need to save it to disk with CSV files or
DuckDB, using a <code>save_to_*</code> function.</li>
<li>chunk_size: if the expanded data is too large to fit in memory, we
need to process it in chunks by specifying how many patients are
processed at one time.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_pp</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_datatable.html">save_to_datatable</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_datatable.html">save_to_datatable</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Other options for big data are to save to csv or DuckDB:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="va">trial_pp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>    output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_csv.html">save_to_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_pp_dir</span>, <span class="st">"trial_csvs"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_csv.html">save_to_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_itt_dir</span>, <span class="st">"trial_csvs"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_expansion_options.html">set_expansion_options</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="../reference/save_to_duckdb.html">save_to_duckdb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">trial_itt_dir</span>, <span class="st">"trial_duckdb"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-sequence-of-trials-data">Create Sequence of Trials Data<a class="anchor" aria-label="anchor" href="#create-sequence-of-trials-data"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_trials.html">expand_trials</a></span><span class="op">(</span><span class="va">trial_pp</span><span class="op">)</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_trials.html">expand_trials</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_pp</span><span class="op">@</span><span class="va">expansion</span></span>
<span><span class="co">#&gt; Expansion: </span></span>
<span><span class="co">#&gt; Chunk size: 500 </span></span>
<span><span class="co">#&gt; Censor at switch: TRUE </span></span>
<span><span class="co">#&gt; First period: 0 | Last period: Inf </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; A TE Datastore Datatable object </span></span>
<span><span class="co">#&gt; N: 500 observations </span></span>
<span><span class="co">#&gt;         id trial_period followup_time outcome    weight treatment         x2</span></span>
<span><span class="co">#&gt;      &lt;int&gt;        &lt;int&gt;         &lt;int&gt;   &lt;num&gt;     &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     1            0             0       0 1.0000000         1  1.1461484</span></span>
<span><span class="co">#&gt;   2:     1            0             1       0 0.8951447         1  1.1461484</span></span>
<span><span class="co">#&gt;  ---                                                                        </span></span>
<span><span class="co">#&gt; 499:    99            0             0       0 1.0000000         1 -0.3463778</span></span>
<span><span class="co">#&gt; 500:    99            0             1       0 1.0122336         1 -0.3463778</span></span>
<span><span class="co">#&gt;        age assigned_treatment</span></span>
<span><span class="co">#&gt;      &lt;num&gt;              &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:    36                  1</span></span>
<span><span class="co">#&gt;   2:    36                  1</span></span>
<span><span class="co">#&gt;  ---                         </span></span>
<span><span class="co">#&gt; 499:    65                  1</span></span>
<span><span class="co">#&gt; 500:    65                  1</span></span>
<span><span class="va">trial_itt</span><span class="op">@</span><span class="va">expansion</span></span>
<span><span class="co">#&gt; Expansion: </span></span>
<span><span class="co">#&gt; Chunk size: 500 </span></span>
<span><span class="co">#&gt; Censor at switch: FALSE </span></span>
<span><span class="co">#&gt; First period: 0 | Last period: Inf </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; A TE Datastore Datatable object </span></span>
<span><span class="co">#&gt; N: 1558 observations </span></span>
<span><span class="co">#&gt;          id trial_period followup_time outcome    weight treatment         x2</span></span>
<span><span class="co">#&gt;       &lt;int&gt;        &lt;int&gt;         &lt;int&gt;   &lt;num&gt;     &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:     1            0             0       0 1.0000000         1  1.1461484</span></span>
<span><span class="co">#&gt;    2:     1            0             1       0 0.9429254         1  1.1461484</span></span>
<span><span class="co">#&gt;   ---                                                                        </span></span>
<span><span class="co">#&gt; 1557:    99            0             6       0 0.8917236         1 -0.3463778</span></span>
<span><span class="co">#&gt; 1558:    99            0             7       1 0.8999358         0 -0.3463778</span></span>
<span><span class="co">#&gt;       assigned_treatment</span></span>
<span><span class="co">#&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:                  1</span></span>
<span><span class="co">#&gt;    2:                  1</span></span>
<span><span class="co">#&gt;   ---                   </span></span>
<span><span class="co">#&gt; 1557:                  1</span></span>
<span><span class="co">#&gt; 1558:                  1</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="sample-or-load-from-expanded-data">Sample or Load from Expanded Data<a class="anchor" aria-label="anchor" href="#sample-or-load-from-expanded-data"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_expanded_data.html">load_expanded_data</a></span><span class="op">(</span><span class="va">trial_itt</span>, seed <span class="op">=</span> <span class="fl">1234</span>, p_control <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/outcome_data.html">outcome_data</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span>
<span><span class="co">#&gt;          id trial_period followup_time outcome    weight treatment         x2</span></span>
<span><span class="co">#&gt;       &lt;int&gt;        &lt;int&gt;         &lt;int&gt;   &lt;num&gt;     &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:    15            0             0       1 1.0000000         1 -0.7365256</span></span>
<span><span class="co">#&gt;    2:    32            0             0       1 1.0000000         1  1.9861380</span></span>
<span><span class="co">#&gt;    3:    33            0             0       0 1.0000000         0 -0.2655281</span></span>
<span><span class="co">#&gt;    4:    92            0             0       0 1.0000000         1 -0.5578694</span></span>
<span><span class="co">#&gt;    5:    26            0             0       0 1.0000000         0  1.6433298</span></span>
<span><span class="co">#&gt;   ---                                                                        </span></span>
<span><span class="co">#&gt; 1554:    51            0            19       0 0.6208347         1 -0.1352684</span></span>
<span><span class="co">#&gt; 1555:    76            0            19       0 0.5602988         0  0.1274581</span></span>
<span><span class="co">#&gt; 1556:    39            0            19       0 1.3517560         1  0.2189413</span></span>
<span><span class="co">#&gt; 1557:     7            0            19       0 0.9499071         1 -1.1510304</span></span>
<span><span class="co">#&gt; 1558:    33            0            19       0 0.8185893         1 -0.2655281</span></span>
<span><span class="co">#&gt;       assigned_treatment sample_weight</span></span>
<span><span class="co">#&gt;                    &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:                  1             1</span></span>
<span><span class="co">#&gt;    2:                  1             1</span></span>
<span><span class="co">#&gt;    3:                  0             1</span></span>
<span><span class="co">#&gt;    4:                  1             1</span></span>
<span><span class="co">#&gt;    5:                  0             1</span></span>
<span><span class="co">#&gt;   ---                                 </span></span>
<span><span class="co">#&gt; 1554:                  1             1</span></span>
<span><span class="co">#&gt; 1555:                  1             1</span></span>
<span><span class="co">#&gt; 1556:                  1             1</span></span>
<span><span class="co">#&gt; 1557:                  1             1</span></span>
<span><span class="co">#&gt; 1558:                  0             1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-marginal-structural-model">Fit Marginal Structural Model<a class="anchor" aria-label="anchor" href="#fit-marginal-structural-model"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial_itt</span><span class="op">@</span><span class="va">outcome_model</span><span class="op">@</span><span class="va">model_fitter</span></span>
<span><span class="co">#&gt; An object of class "te_stats_glm_logit"</span></span>
<span><span class="co">#&gt; Slot "save_path":</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="va">trial_itt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_msm.html">fit_msm</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span><span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h3>
<p>Model summaries not implemented</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_marginal.html">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">trial_itt</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/outcome_data.html">outcome_data</a></span><span class="op">(</span><span class="va">trial_itt</span><span class="op">)</span><span class="op">[</span><span class="va">trial_period</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>  predict_times <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">followup_time</span>, <span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">survival_diff</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Follow up"</span>, ylab <span class="op">=</span> <span class="st">"Survival difference"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">followup_time</span>, <span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">`2.5%`</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">followup_time</span>, <span class="va">preds</span><span class="op">$</span><span class="va">difference</span><span class="op">$</span><span class="va">`97.5%`</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="new-interface_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="flowchart">Flowchart<a class="anchor" aria-label="anchor" href="#flowchart"></a>
</h3>
<div class="float">
<img src="img/trial_sequence_functions_overview_solid.png" alt="Flowchart"><div class="figcaption">Flowchart</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="class-structure">Class Structure<a class="anchor" aria-label="anchor" href="#class-structure"></a>
</h2>
<p>The main class in this new interface is <code>trial_sequence</code>
which is the parent class of the estimand specific classes
<code>trial_sequence_ITT</code>, <code>trial_sequence_PP</code> and
<code>trial_sequence_AT</code>. These child classes allow for
restrictions and differences in processing based on the different
estimands. Where necessary we have S4 methods defined for the estimand
specific classes and otherwise common processing is defined in methods
for the <code>trial_sequence</code> class.</p>
<p>The <code>trial_sequence</code> class contains slots needed to define
the sequence of target trials analysis</p>
<ul>
<li>estimand = <code>character</code>
</li>
<li>data = <code>te_data</code>
</li>
<li>censor_weights = <code>te_weights_spec</code>
</li>
<li>expansion = <code>te_expansion</code>
</li>
<li>outcome_model = <code>te_outcome_model</code>
</li>
</ul>
<div class="section level3">
<h3 id="te_data">
<code>te_data</code><a class="anchor" aria-label="anchor" href="#te_data"></a>
</h3>
<p>Contains the input data. It under goes some manipulation in
<code><a href="../reference/set_data.html">set_data()</a></code> to standardise the column names.</p>
</div>
<div class="section level3">
<h3 id="te_weights_spec">
<code>te_weights_spec</code><a class="anchor" aria-label="anchor" href="#te_weights_spec"></a>
</h3>
<p>Contains specification for the IPCW models, including formulas, model
fitter, pooling option, and (once fitted) the model summaries.</p>
<div class="section level4">
<h4 id="te_weights_fitter">te_weights_fitter<a class="anchor" aria-label="anchor" href="#te_weights_fitter"></a>
</h4>
<p>The model fitter is specified as an object of class
<code>te_weights_fitter</code>. This class is used to save parameters
which are used in the method
<code>fit_weights_model(object, data, formula, label)</code> where
object is the <code>te_weights_fitter</code>. It fits a model and
returns a <code>te_weights_fitted</code> object containing the label,
model summaries and the fitted values from the model.</p>
</div>
<div class="section level4">
<h4 id="te_weights_fitted">te_weights_fitted<a class="anchor" aria-label="anchor" href="#te_weights_fitted"></a>
</h4>
<p>The <code>te_weights_fitted</code> objects are saved in a list in
<code>te_weights_spec</code> in a slot <code>fitted</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="te_outcome_model">
<code>te_outcome_model</code><a class="anchor" aria-label="anchor" href="#te_outcome_model"></a>
</h3>
<p>To be finalised.</p>
</div>
<div class="section level3">
<h3 id="te_expansion">
<code>te_expansion</code><a class="anchor" aria-label="anchor" href="#te_expansion"></a>
</h3>
<p>The <code>te_expansion</code> class defines how the sequence of
trials should be expanded. It contains slots for chunk_size, how
censoring is applied, first and last periods, and an object of class
<code>te_datastore</code> which defines how the data is saved.</p>
<div class="section level4">
<h4 id="te_datastore">
<code>te_datastore</code><a class="anchor" aria-label="anchor" href="#te_datastore"></a>
</h4>
<p>This class contains slots needed for saving the expanded data, such
as file path. Child classes are defined for each storage type, such as
<code>te_datastore_csv</code>, <code>te_datastore_duckdb</code>. Each of
these classes has a user-friendly <code>save_to_*()</code> method to
setup the storage.</p>
<p>To define a new storage type, a method
<code>save_expanded_data(object, data)</code> needs to be defined. This
takes the data store object and a <code>data.frame</code> to be saved.
This method may be called repeatedly if only a chunk of patients are
being processed and so should appropriately append the data. The method
returns an updated <code>te_datastore_*</code> object which is saved in
the <code>trial_sequence@te_expansion</code> slot.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roonak Rezvani, Isaac Gravestock, Li Su, Julia Moesch, Medical Research Council (MRC), F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
