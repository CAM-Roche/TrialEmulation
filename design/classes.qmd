---
title: "classes"
output: html_document
date: "2024-02-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Classes in TrialEmulation

Based on editor feedback we should improve our use of classes and methods.

Some easy things: - add print/show methods - add summary methods - make `trial_msm` take an object from `data_preparation()` (it does but it's said differently in the docs)

Some other things: - allow modularity and extensibility of classes and methods, eg alternative weight or outcome models

## Design

1.  input data object
2.  weight model class

-   censoring weights object
    -   fit_glm class
-   switching weights object
    -   fit_glm class

3.  data extension method

-   data output object: {data.table, csv, duckdb/sqlite}

4.  MSM model fit
5.  predict

```{r}
#| eval: false

tte <- trial_sequence(estimand = "PP") |>
  set_data(trial_example, id = "ID", treatment = "drug", outcome = "Death", eligible = "IE")

tte <- trial_sequence(estimand = "ITT") |> set_data(trial_example)
tte_PP <- trial_sequence(estimand = "PP") |> set_data(trial_example)
# message:
# A per-protocol analysis requires specification of treatment switching model with set_switch_weight_model()
tte2 <- tte |>
  set_switch_weight_model(
    numerator = ~ age + biomarker,
    denominator = ~ age + biomarker,
    pooled = TRUE,
    save_models = "~/my_TTE",
    model_type = glm()
  ) |>
  set_censor_weight_model(numerator = ~ age + biomarker, denominator = ~ age + biomarker, pooled = TRUE) |>
  set_expansion_options(chunks = 500, output = csv_files(dir = tempdir()))

initiators(tte2) # error! modelling options are not set

tte3 <- calculate_weights(tte2)
expanded_tte3 <- expand_trials(tte3)

expanded_tte3 <- set_outcome_model(expanded_tte3, ~ age + biomarker + time + time^2)
results <- fit_msm(expanded_tte3)

predict(tte3) # error! run fit_msm on this model
predict(results)
```


The TTE object always inherits from the "tte" parent class. After expanding it becomes a 
"expanded_TTE" which inherits and then a "msm_TTE" the same.

`initiators()` is, as before, an all in one function but takes a completely specified trial object


Arbitrary weighting models could be set
```{r}
my_weight_function <- function(formula, data, filename) {
  return(list(summary, fit_summary, weights))
}
```
