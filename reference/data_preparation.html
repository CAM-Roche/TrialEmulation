<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Data Preparation Function — data_preparation • RandomisedTrialsEmulation</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Data Preparation Function — data_preparation"><meta property="og:description" content="This function prepare the data for modelling."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RandomisedTrialsEmulation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Getting-Started.html">Getting-Started</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Data Preparation Function</h1>
    
    <div class="hidden name"><code>data_preparation.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function prepare the data for modelling.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">data_preparation</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>  eligible <span class="op">=</span> <span class="st">"eligible"</span>,</span>
<span>  outcome_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  model_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  switch_n_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  switch_d_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  first_period <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  last_period <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  use_weight <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  use_censor <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  check_missing <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  cense <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  pool_cense <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  cense_d_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  cense_n_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  include_followup_time_case <span class="op">=</span> <span class="op">~</span><span class="va">followup_time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">followup_time</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  include_expansion_time_case <span class="op">=</span> <span class="op">~</span><span class="va">for_period</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">for_period</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  include_regime_length <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  eligible_wts_0 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  eligible_wts_1 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  lag_p_nosw <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  where_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">data_dir</span>,</span>
<span>  save_weight_models <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  separate_files <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>data</dt>
<dd><p>A <code>data.frame</code> containing all the required columns.</p></dd>


<dt>id</dt>
<dd><p>Name of the data column for id feature Defaults to id</p></dd>


<dt>period</dt>
<dd><p>Name of the data column for period feature Defaults to period</p></dd>


<dt>treatment</dt>
<dd><p>Name of the data column for treatment feature Defaults to treatment</p></dd>


<dt>outcome</dt>
<dd><p>Name of the data column for outcome feature Defaults to outcome</p></dd>


<dt>eligible</dt>
<dd><p>Indicator of whether or not an observation is eligible to be expanded about Defaults to eligible</p></dd>


<dt>outcome_cov</dt>
<dd><p>A RHS formula with baseline covariates to adjust in final model</p></dd>


<dt>model_var</dt>
<dd><p>List of Variables of interest to be used in final model.
Derived variables to use in outcome models. Typically <code>assigned_treatment</code> for ITT and per-protocol,
and <code>dose + dose^2</code> for as-treated. <code>time_on_regime</code>? TODO check what else is derived</p></dd>


<dt>switch_n_cov</dt>
<dd><p>A RHS formula for modelling probability of switching treatment. Used in the numerator of weight
calculation.</p></dd>


<dt>switch_d_cov</dt>
<dd><p>A RHS formula for modelling probability of switching treatment. Used in the denominator of weight
calculation.</p></dd>


<dt>first_period</dt>
<dd><p>First period value to start expanding about</p></dd>


<dt>last_period</dt>
<dd><p>Last period value to expand about</p></dd>


<dt>use_weight</dt>
<dd><p>Use weights in analysis. If 0 then no weights will be calculated.</p></dd>


<dt>use_censor</dt>
<dd><p>Use censoring for per-protocol analysis - censor person-times once a person-trial stops taking the
initial treatment value</p></dd>


<dt>check_missing</dt>
<dd><p>Check for missing values in final model when use_censor=1 (Not added yet!)</p></dd>


<dt>cense</dt>
<dd><p>Censoring variable</p></dd>


<dt>pool_cense</dt>
<dd><p>Pool the numerator and denominator models (0: split models by previous treatment Am1 = 0 and
Am1 = 1 as in treatment models and 1: pool all observations together into a single numerator and denominator model)
Defaults to 0</p></dd>


<dt>cense_d_cov</dt>
<dd><p>A RHS formula for modelling probability of being censored. Used in the numerator of weight
calculation.</p></dd>


<dt>cense_n_cov</dt>
<dd><p>A RHS formula for modelling probability of being censored. Used in the denominator of weight
calculation.</p></dd>


<dt>include_followup_time_case</dt>
<dd><p>The model to include <code>followup_time</code> in outcome model, specified as a RHS formula.</p></dd>


<dt>include_expansion_time_case</dt>
<dd><p>The model to include <code>for_period</code> in outcome model, specified as a RHS formula.</p></dd>


<dt>include_regime_length</dt>
<dd><p>If defined as 1 a new variable (time_on_regime) is added to dataset.
This variable stores the duration of time that the patient has been on the current treatment value</p></dd>


<dt>eligible_wts_0</dt>
<dd><p>Eligibility criteria used in weights for model condition Am1 = 0</p></dd>


<dt>eligible_wts_1</dt>
<dd><p>Eligibility criteria used in weights for model condition Am1 = 1</p></dd>


<dt>lag_p_nosw</dt>
<dd><p>When 1 this will set the first weight to be 1 and use p_nosw_d and p_nosw_n at followup-time (t-1)
for calculating the weights at followup-time t - can be set to 0 which will increase the maximum and variance of
weights (Defaults to 1)</p></dd>


<dt>where_var</dt>
<dd><p>List of variables used in where conditions used in subsetting the data used in final analysis
(where_case), the variables not included in the final model</p></dd>


<dt>data_dir</dt>
<dd><p>Directory to model objects when <code>save_weight_models=TRUE</code> and
expanded data as <code>trial_i.csv</code>s if <code>separate_files = TRUE</code>.
If the specified directory does not exist it will be created. If the directory
already contains trial files an error will occur, other files may be overwritten.</p></dd>


<dt>save_weight_models</dt>
<dd><p>Save weight models objects in <code>data_dir</code>.</p></dd>


<dt>chunk_size</dt>
<dd><p>Number of patients to process in one chunk when <code>separate_files = TRUE</code></p></dd>


<dt>separate_files</dt>
<dd><p>Save expanded data in separate CSV files for each trial.</p></dd>


<dt>quiet</dt>
<dd><p>Don't print progress messages.</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The arguments <code>chunk_size</code> and <code>separate_files</code> allow for processing of large datasets that
would not fit in memory once expanded. When <code>separate_files = TRUE</code>, the input data are processed
in chunks of patients and saved into separate files for each trial starting period. These separate
files can be sampled to create the dataset for the modelling.</p>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Roonak Rezvani, Isaac Gravestock, Li Su.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

